<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Surveillance Mobile</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            animation: gradientShift 10s ease infinite;
        }
        @keyframes gradientShift {
            0% { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
            25% { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
            50% { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
            75% { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
            100% { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        }
        .container { 
            max-width: 400px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px; 
            padding: 30px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 { 
            color: white; 
            text-align: center; 
            margin-bottom: 30px; 
            font-size: 28px; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        select, input { 
            width: 100%; 
            padding: 15px; 
            border: none;
            border-radius: 12px; 
            font-size: 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        select::placeholder, input::placeholder { color: rgba(255, 255, 255, 0.7); }
        select option { background: #333; color: white; }
        button { 
            width: 100%; 
            padding: 15px; 
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white; 
            border: none; 
            cursor: pointer; 
            margin-top: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .success { 
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white; 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .error { 
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white; 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .tabs { 
            display: flex; 
            margin-bottom: 25px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .tab { 
            flex: 1; 
            padding: 15px 10px; 
            background: rgba(255, 255, 255, 0.1);
            border: none; 
            cursor: pointer;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .tab.active { 
            background: linear-gradient(45deg, #3498db, #2980b9);
            transform: scale(1.05);
        }
        .tab:hover { background: rgba(255, 255, 255, 0.2); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .education-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .education-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        .education-item h3 {
            color: white;
            margin-bottom: 5px;
        }
        .education-item p {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Health Surveillance</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('health')">üè• Health</button>
            <button class="tab" onclick="showTab('water')">üíß Water</button>
            <button class="tab" onclick="showTab('community')">üë• Community</button>
            <button class="tab" onclick="showTab('education')">üìö Education</button>
            <button class="tab" onclick="showTab('offline')">üì± Offline</button>
        </div>

        <div id="health" class="tab-content active">
            <form id="healthForm">
                <div class="form-group">
                    <label>Disease:</label>
                    <select name="disease" required>
                        <option value="">Select Disease</option>
                        <option value="diarrhea">Diarrhea</option>
                        <option value="cholera">Cholera</option>
                        <option value="typhoid">Typhoid</option>
                        <option value="hepatitis_a">Hepatitis A</option>
                        <option value="dysentery">Dysentery</option>
                        <option value="gastroenteritis">Gastroenteritis</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Severity:</label>
                    <select name="severity" required>
                        <option value="">Select Severity</option>
                        <option value="mild">Mild</option>
                        <option value="moderate">Moderate</option>
                        <option value="severe">Severe</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Location:</label>
                    <input type="text" name="location" placeholder="Enter location" required>
                </div>
                <div class="form-group">
                    <label>Patient Age:</label>
                    <input type="number" name="patient_age" min="1" max="120" placeholder="25" value="25">
                </div>
                <div class="form-group">
                    <label>Patient Gender:</label>
                    <select name="patient_gender">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <button type="submit">Submit Health Report</button>
                <button type="button" id="voiceReportBtn" onclick="startVoiceReport()" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); margin-top: 10px;">üé§ Voice Report</button>
                <div id="voiceStatus" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; color: white;"></div>
            </form>
        </div>

        <div id="water" class="tab-content">
            <form id="waterForm">
                <div class="form-group">
                    <label>Water Safe:</label>
                    <select name="is_safe" required>
                        <option value="">Select Status</option>
                        <option value="true">Safe</option>
                        <option value="false">Contaminated</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>pH Level:</label>
                    <input type="number" name="ph_level" step="0.1" min="0" max="14" placeholder="7.0" required>
                </div>
                <div class="form-group">
                    <label>Turbidity:</label>
                    <input type="number" name="turbidity" step="0.1" min="0" placeholder="5.0" required>
                </div>
                <div class="form-group">
                    <label>Bacterial Count:</label>
                    <input type="number" name="bacterial_count" min="0" placeholder="100" required>
                </div>
                <div class="form-group">
                    <label>Temperature (¬∞C):</label>
                    <input type="number" name="temperature" step="0.1" placeholder="25.0" required>
                </div>
                <div class="form-group">
                    <label>Location:</label>
                    <input type="text" name="location" placeholder="Enter location" required>
                </div>
                <div class="form-group">
                    <label>Source Type:</label>
                    <select name="source_type" required>
                        <option value="">Select Source</option>
                        <option value="well">Well</option>
                        <option value="river">River</option>
                        <option value="pond">Pond</option>
                        <option value="tap">Tap Water</option>
                    </select>
                </div>
                <button type="submit">Submit Water Report</button>
            </form>
        </div>

        <!-- Community Reporting Tab -->
        <div id="community" class="tab-content">
            <h2 style="color: white; text-align: center; margin-bottom: 20px;">üë• Community Reporting</h2>
            
            <!-- Quick Symptom Buttons -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <button type="button" onclick="quickReport('fever')" style="background: linear-gradient(45deg, #e74c3c, #c0392b); padding: 20px; font-size: 14px;">ü§í I have Fever</button>
                <button type="button" onclick="quickReport('diarrhea')" style="background: linear-gradient(45deg, #f39c12, #e67e22); padding: 20px; font-size: 14px;">ü§¢ I have Diarrhea</button>
                <button type="button" onclick="quickReport('vomiting')" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); padding: 20px; font-size: 14px;">ü§Æ I have Vomiting</button>
                <button type="button" onclick="quickReport('jaundice')" style="background: linear-gradient(45deg, #f1c40f, #f39c12); padding: 20px; font-size: 14px;">üò∑ I have Jaundice</button>
            </div>
            
            <!-- Voice Recording -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="color: white; margin-bottom: 15px;">üé§ Voice Report (For Illiterate Users)</h3>
                <button type="button" id="voiceBtn" onclick="toggleVoiceRecording()" style="background: linear-gradient(45deg, #2ecc71, #27ae60);">üé§ Start Voice Recording</button>
                <div id="voiceStatus" style="color: white; margin-top: 10px; font-size: 14px;"></div>
            </div>
            
            <!-- SMS Fallback -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
                <h3 style="color: white; margin-bottom: 15px;">üì± SMS Fallback (No Internet)</h3>
                <p style="color: white; font-size: 14px; margin-bottom: 10px;">Send SMS to: <strong>+91-1234567890</strong></p>
                <p style="color: white; font-size: 12px;">Format: HEALTH [SYMPTOM] [LOCATION] [AGE]</p>
                <p style="color: white; font-size: 12px;">Example: HEALTH FEVER GUWAHATI 25</p>
            </div>
        </div>
        
        <!-- Education Tab -->
        <div id="education" class="tab-content">
            <h2 style="color: white; text-align: center; margin-bottom: 20px;">üìö Health Education</h2>
            
            <!-- Language Selection -->
            <div class="form-group">
                <label>üåê Select Language:</label>
                <select id="languageSelect" onchange="changeLanguage()">
                    <option value="en">English</option>
                    <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                    <option value="as">‡¶Ö‡¶∏‡¶Æ‡ßÄ‡¶Ø‡¶º‡¶æ (Assamese)</option>
                    <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
                </select>
            </div>
            
            <!-- Education Content -->
            <div style="max-height: 300px; overflow-y: auto;">
                <div class="education-item" onclick="showEducationContent('handwashing')">
                    <h3>üßº Handwashing</h3>
                    <p>Learn proper handwashing techniques</p>
                </div>
                <div class="education-item" onclick="showEducationContent('water')">
                    <h3>üíß Safe Drinking Water</h3>
                    <p>How to ensure water safety</p>
                </div>
                <div class="education-item" onclick="showEducationContent('food')">
                    <h3>üçΩÔ∏è Food Hygiene</h3>
                    <p>Safe food preparation and storage</p>
                </div>
                <div class="education-item" onclick="showEducationContent('ors')">
                    <h3>ü•§ ORS Preparation</h3>
                    <p>How to prepare Oral Rehydration Solution</p>
                </div>
                <div class="education-item" onclick="showEducationContent('monsoon')">
                    <h3>üåßÔ∏è Monsoon Tips</h3>
                    <p>Seasonal health precautions</p>
                </div>
            </div>
        </div>
        
        <!-- Offline Mode Tab -->
        <div id="offline" class="tab-content">
            <h2 style="color: white; text-align: center; margin-bottom: 20px;">üì± Offline Mode</h2>
            
            <!-- Connection Status -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="color: white; margin-bottom: 10px;">üåê Connection Status</h3>
                <div id="connectionStatus" style="color: white; font-weight: bold;">Checking...</div>
                <div id="lastSync" style="color: white; font-size: 14px; margin-top: 5px;"></div>
            </div>
            
            <!-- Offline Data -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="color: white; margin-bottom: 10px;">üíæ Stored Offline Data</h3>
                <div id="offlineStats" style="color: white; font-size: 14px;"></div>
                <button onclick="syncOfflineData()" style="background: linear-gradient(45deg, #3498db, #2980b9); margin-top: 10px;">üîÑ Sync Now</button>
            </div>
            
            <!-- GPS Location -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
                <h3 style="color: white; margin-bottom: 10px;">üìç GPS Location</h3>
                <div id="gpsLocation" style="color: white; font-size: 14px; margin-bottom: 10px;">Getting location...</div>
                <button onclick="getGPSLocation()" style="background: linear-gradient(45deg, #2ecc71, #27ae60);">üìç Update Location</button>
            </div>
        </div>
        
        <div id="alert" class="tab-content">
            <h2 style="color: white; text-align: center; margin-bottom: 20px;">üö® Alerts & Notifications</h2>
            
            <!-- Push Notifications -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="color: white; margin-bottom: 15px;">üîî Enable Notifications</h3>
                <button onclick="enableNotifications()" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">üîî Enable Push Notifications</button>
            </div>
            
            <!-- Recent Alerts -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="color: white; margin-bottom: 15px;">üì¢ Recent Alerts</h3>
                <div id="alertsList" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
            
            <!-- Emergency Instructions -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
                <h3 style="color: white; margin-bottom: 15px;">‚ö° Emergency Instructions</h3>
                <div id="emergencyInstructions" style="color: white; font-size: 14px;">
                    <p>‚Ä¢ Boil water for 10 minutes before drinking</p>
                    <p>‚Ä¢ Give ORS to children with diarrhea</p>
                    <p>‚Ä¢ Wash hands frequently with soap</p>
                    <p>‚Ä¢ Avoid street food during outbreaks</p>
                </div>
            </div>
        </div>ty:</label>
                    <select name="severity" required>
                        <option value="">Select Severity</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Location:</label>
                    <input type="text" name="location" placeholder="Enter location" value="Mobile Report">
                </div>
                <div class="form-group">
                    <label>Message:</label>
                    <input type="text" name="message" placeholder="Alert description" required>
                </div>
                <button type="submit">Create Alert</button>
            </form>
        </div>

        <div id="message"></div>
        
        <!-- Dashboard Section -->
        <div class="tabs" style="margin-top: 30px;">
            <button class="tab" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('alerts-view')">üö® View Alerts</button>
            <button class="tab" onclick="showTab('profile')">üë§ Profile</button>
        </div>

        <div id="dashboard" class="tab-content">
            <h3 style="color: white; margin-bottom: 20px;">üìä Health Statistics</h3>
            <div id="stats-container" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="color: white; margin-bottom: 10px;">üìã Total Reports: <span id="total-reports">Loading...</span></div>
                <div style="color: white; margin-bottom: 10px;">üö® Active Alerts: <span id="active-alerts">Loading...</span></div>
                <div style="color: white; margin-bottom: 10px;">üíß Water Sources: <span id="water-sources">Loading...</span></div>
            </div>
            <button onclick="loadDashboard()">üîÑ Refresh Stats</button>
        </div>

        <div id="alerts-view" class="tab-content">
            <h3 style="color: white; margin-bottom: 20px;">üö® Recent Alerts</h3>
            <div id="alerts-container"></div>
            <button onclick="loadAlerts()">üîÑ Refresh Alerts</button>
        </div>

        <div id="profile" class="tab-content">
            <h3 style="color: white; margin-bottom: 20px;">üë§ User Profile</h3>
            <div class="form-group">
                <label>üì± Device Info:</label>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; color: white;">
                    <div>üì± Platform: <span id="platform"></span></div>
                    <div>üåê Browser: <span id="browser"></span></div>
                    <div>üìç Location: <span id="location">Getting location...</span></div>
                    <div>‚è∞ Last Active: <span id="last-active"></span></div>
                </div>
            </div>
            <button onclick="getLocation()">üìç Update Location</button>
            <button onclick="installApp()" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); margin-top: 10px;">üì± Install App</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000/api';
        
        // Check if server is running
        async function checkServer() {
            try {
                await fetch(`${API_URL.replace('/api', '')}/health`);
                return true;
            } catch {
                showMessage('Backend server not running! Start with: uvicorn main:app --reload', 'error');
                return false;
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.innerHTML = `<div class="${type}">${text}</div>`;
            setTimeout(() => msg.innerHTML = '', 3000);
        }

        document.getElementById('healthForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            data.patient_age = parseInt(data.patient_age) || 25;
            
            try {
                const response = await fetch(`${API_URL}/health/reports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showMessage('Health report submitted successfully!', 'success');
                    e.target.reset();
                } else {
                    showMessage('Failed to submit health report', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        });

        document.getElementById('waterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            data.is_safe = data.is_safe === 'true';
            data.ph_level = parseFloat(data.ph_level);
            data.turbidity = parseFloat(data.turbidity);
            data.bacterial_count = parseInt(data.bacterial_count);
            data.temperature = parseFloat(data.temperature);
            // source_type comes from form now
            
            try {
                const response = await fetch(`${API_URL}/water/sources`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showMessage('Water quality report submitted successfully!', 'success');
                    e.target.reset();
                } else {
                    showMessage('Failed to submit water report', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        });

        // Voice Recording Variables
        let isRecording = false;
        let mediaRecorder;
        let voiceReportData = null;
        
        // Voice Report for Health Tab
        async function startVoiceReport() {
            const voiceBtn = document.getElementById('voiceReportBtn');
            const voiceStatus = document.getElementById('voiceStatus');
            
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    let audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        processVoiceReport(audioBlob);
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    voiceBtn.textContent = '‚èπÔ∏è Stop Recording';
                    voiceBtn.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
                    voiceStatus.style.display = 'block';
                    voiceStatus.innerHTML = 'üéôÔ∏è Recording... Speak your health report now';
                } catch (error) {
                    showMessage('Voice recording not supported', 'error');
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                voiceBtn.textContent = 'üé§ Voice Report';
                voiceBtn.style.background = 'linear-gradient(45deg, #9b59b6, #8e44ad)';
                voiceStatus.innerHTML = '‚è≥ Processing voice report...';
            }
        }
        
        async function processVoiceReport(audioBlob) {
            const voiceStatus = document.getElementById('voiceStatus');
            
            // Simulate speech-to-text processing
            setTimeout(() => {
                // Mock transcription - in real app, this would use speech recognition API
                const mockTranscriptions = [
                    { disease: 'diarrhea', severity: 'moderate', location: 'Village Center' },
                    { disease: 'cholera', severity: 'severe', location: 'Water Source Area' },
                    { disease: 'typhoid', severity: 'mild', location: 'Community Hall' }
                ];
                
                const transcription = mockTranscriptions[Math.floor(Math.random() * mockTranscriptions.length)];
                
                // Auto-fill the form with voice data
                document.querySelector('select[name="disease"]').value = transcription.disease;
                document.querySelector('select[name="severity"]').value = transcription.severity;
                document.querySelector('input[name="location"]').value = transcription.location;
                
                voiceStatus.innerHTML = `‚úÖ Voice report processed: ${transcription.disease} (${transcription.severity}) at ${transcription.location}<br><button onclick="submitVoiceReport()" style="margin-top: 10px; padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer;">Submit Voice Report</button>`;
                
                voiceReportData = {
                    ...transcription,
                    patient_age: 25,
                    patient_gender: 'unknown',
                    source: 'voice'
                };
            }, 2000);
        }
        
        async function submitVoiceReport() {
            if (!voiceReportData) return;
            
            const voiceStatus = document.getElementById('voiceStatus');
            voiceStatus.innerHTML = '‚è≥ Submitting voice report...';
            
            try {
                const response = await fetch(`${API_URL}/health/reports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(voiceReportData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    voiceStatus.innerHTML = '‚úÖ Voice report submitted successfully!';
                    voiceReportData = null;
                    // Clear form
                    document.getElementById('healthForm').reset();
                    setTimeout(() => {
                        voiceStatus.style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Submission failed');
                }
            } catch (error) {
                voiceStatus.innerHTML = `‚ùå Error: ${error.message}`;
                // Store offline if network error
                if (!navigator.onLine) {
                    saveOfflineReport(voiceReportData);
                    voiceStatus.innerHTML = 'üì± Voice report saved offline. Will sync when online.';
                }
            }
        }
        
        // Community Voice Recording (separate function)
        function toggleVoiceRecording() {
            if (!isRecording) {
                startVoiceRecording();
            } else {
                stopVoiceRecording();
            }
        }
        
        async function startVoiceRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('voiceBtn').textContent = 'üî¥ Stop Recording';
                document.getElementById('voiceStatus').textContent = 'Recording... Speak now';
                
                mediaRecorder.ondataavailable = (event) => {
                    // In real app, send audio to speech-to-text service
                    console.log('Audio recorded:', event.data);
                };
                
                mediaRecorder.onstop = () => {
                    document.getElementById('voiceBtn').textContent = 'üé§ Start Voice Recording';
                    document.getElementById('voiceStatus').textContent = 'Recording saved! Processing...';
                    
                    // Simulate processing
                    setTimeout(() => {
                        document.getElementById('voiceStatus').textContent = 'Voice report submitted successfully!';
                        quickReport('voice_report');
                    }, 2000);
                };
            } catch (error) {
                showMessage('Microphone access denied', 'error');
            }
        }
        
        function stopVoiceRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
            }
        }
        
        // Quick Community Reporting
        async function quickReport(symptom) {
            const reportData = {
                disease: symptom,
                severity: 'mild',
                location: localStorage.getItem('userLocation') || 'Community Report',
                patient_age: 25,
                patient_gender: 'unknown'
            };
            
            try {
                if (navigator.onLine) {
                    const response = await fetch(`${API_URL}/health/reports`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(reportData)
                    });
                    
                    if (response.ok) {
                        showMessage(`${symptom} report submitted successfully!`, 'success');
                    } else {
                        throw new Error('Server error');
                    }
                } else {
                    // Store offline
                    saveOfflineReport(reportData);
                    showMessage(`${symptom} report saved offline. Will sync when online.`, 'success');
                }
            } catch (error) {
                saveOfflineReport(reportData);
                showMessage(`${symptom} report saved offline.`, 'success');
            }
        }
        
        // Offline Data Management
        function saveOfflineReport(data) {
            const offlineReports = JSON.parse(localStorage.getItem('offlineReports') || '[]');
            offlineReports.push({ ...data, timestamp: new Date().toISOString(), synced: false });
            localStorage.setItem('offlineReports', JSON.stringify(offlineReports));
            updateOfflineStats();
        }
        
        async function syncOfflineData() {
            const offlineReports = JSON.parse(localStorage.getItem('offlineReports') || '[]');
            const unsynced = offlineReports.filter(r => !r.synced);
            
            if (unsynced.length === 0) {
                showMessage('No offline data to sync', 'success');
                return;
            }
            
            let synced = 0;
            for (const report of unsynced) {
                try {
                    const response = await fetch(`${API_URL}/health/reports`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(report)
                    });
                    
                    if (response.ok) {
                        report.synced = true;
                        synced++;
                    }
                } catch (error) {
                    console.error('Sync failed for report:', report);
                }
            }
            
            localStorage.setItem('offlineReports', JSON.stringify(offlineReports));
            localStorage.setItem('lastSync', new Date().toISOString());
            
            showMessage(`Synced ${synced} reports successfully!`, 'success');
            updateOfflineStats();
        }
        
        function updateOfflineStats() {
            const offlineReports = JSON.parse(localStorage.getItem('offlineReports') || '[]');
            const unsynced = offlineReports.filter(r => !r.synced).length;
            const total = offlineReports.length;
            
            document.getElementById('offlineStats').innerHTML = `
                <p>Total reports: ${total}</p>
                <p>Unsynced: ${unsynced}</p>
                <p>Synced: ${total - unsynced}</p>
            `;
            
            const lastSync = localStorage.getItem('lastSync');
            if (lastSync) {
                document.getElementById('lastSync').textContent = `Last sync: ${new Date(lastSync).toLocaleString()}`;
            }
        }
        
        // GPS Location
        function getGPSLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lng = position.coords.longitude.toFixed(6);
                        const location = `${lat}, ${lng}`;
                        
                        localStorage.setItem('userLocation', location);
                        document.getElementById('gpsLocation').textContent = `Location: ${location}`;
                        
                        // Auto-fill location in forms
                        const locationInputs = document.querySelectorAll('input[name="location"]');
                        locationInputs.forEach(input => {
                            if (!input.value) input.value = location;
                        });
                    },
                    (error) => {
                        document.getElementById('gpsLocation').textContent = 'Location access denied';
                    }
                );
            } else {
                document.getElementById('gpsLocation').textContent = 'GPS not supported';
            }
        }
        
        // Connection Status
        function updateConnectionStatus() {
            const status = navigator.onLine ? 'Online' : 'Offline';
            const color = navigator.onLine ? '#2ecc71' : '#e74c3c';
            document.getElementById('connectionStatus').innerHTML = `<span style="color: ${color}">‚Ä¢ ${status}</span>`;
        }
        
        // Education Content
        const educationContent = {
            handwashing: {
                en: "1. Wet hands with clean water\n2. Apply soap\n3. Rub for 20 seconds\n4. Rinse with clean water\n5. Dry with clean towel",
                hi: "‡§π‡§æ‡§• ‡§ß‡•ã‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§æ‡§´ ‡§™‡§æ‡§®‡•Ä ‡§î‡§∞ ‡§∏‡§æ‡§¨‡•Å‡§® ‡§ï‡§æ ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞‡•á‡§Ç"
            },
            water: {
                en: "1. Boil water for 10 minutes\n2. Store in clean container\n3. Use clean cups to drink\n4. Avoid ice from unknown sources",
                hi: "‡§™‡§æ‡§®‡•Ä ‡§ï‡•ã 10 ‡§Æ‡§ø‡§®‡§ü ‡§â‡§¨‡§æ‡§≤‡•á‡§Ç ‡§î‡§∞ ‡§∏‡§æ‡§Ø ‡§¨‡§∞‡•ç‡§§‡§® ‡§Æ‡•á‡§Ç ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§ï‡§∞‡•á‡§Ç"
            },
            ors: {
                en: "ORS Recipe:\n1. 1 liter clean water\n2. 6 teaspoons sugar\n3. 1/2 teaspoon salt\n4. Mix well and give small sips",
                hi: "ORS ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è: 1 ‡§≤‡•Ä‡§ü‡§∞ ‡§™‡§æ‡§®‡•Ä, 6 ‡§ö‡§Æ‡•ç‡§Æ‡§ö ‡§ö‡•Ä‡§®‡•Ä, ‡§Ü‡§ß‡§æ ‡§ö‡§Æ‡•ç‡§Æ‡§ö ‡§®‡§Æ‡§ï"
            }
        };
        
        function showEducationContent(topic) {
            const language = document.getElementById('languageSelect').value;
            const content = educationContent[topic]?.[language] || educationContent[topic]?.en || 'Content not available';
            
            alert(content);
            
            // Text-to-speech for illiterate users
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(content);
                utterance.lang = language === 'hi' ? 'hi-IN' : 'en-US';
                speechSynthesis.speak(utterance);
            }
        }
        
        function changeLanguage() {
            const language = document.getElementById('languageSelect').value;
            localStorage.setItem('selectedLanguage', language);
            // In real app, update all UI text based on language
        }
        
        // Push Notifications
        async function enableNotifications() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    showMessage('Notifications enabled successfully!', 'success');
                    
                    // Show sample notification
                    new Notification('Health Alert', {
                        body: 'Water contamination reported in your area. Boil water before drinking.',
                        icon: '/favicon.ico'
                    });
                } else {
                    showMessage('Notification permission denied', 'error');
                }
            } else {
                showMessage('Notifications not supported', 'error');
            }
        }
        
        // Load alerts
        async function loadAlerts() {
            try {
                const response = await fetch(`${API_URL}/alerts`);
                const alerts = await response.json();
                
                const alertsList = document.getElementById('alertsList');
                if (alerts.length === 0) {
                    alertsList.innerHTML = '<p style="color: white;">No alerts at this time</p>';
                } else {
                    alertsList.innerHTML = alerts.slice(0, 5).map(alert => `
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; margin-bottom: 10px; border-radius: 8px;">
                            <div style="color: white; font-weight: bold;">${alert.severity?.toUpperCase()}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 12px;">${new Date(alert.created_at).toLocaleDateString()}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                document.getElementById('alertsList').innerHTML = '<p style="color: white;">Error loading alerts</p>';
            }
        }

        // Initialize app
        window.onload = function() {
            loadDashboard();
            loadAlerts();
            loadProfile();
        };

        // Dashboard functions
        async function loadDashboard() {
            try {
                const [healthStats, alertStats, waterStats] = await Promise.all([
                    fetch(`${API_URL}/health/reports/stats`).then(r => r.json()),
                    fetch(`${API_URL}/alerts/stats`).then(r => r.json()),
                    fetch(`${API_URL}/water/reports/stats`).then(r => r.json())
                ]);
                
                document.getElementById('total-reports').textContent = healthStats.total_reports || 0;
                document.getElementById('active-alerts').textContent = alertStats.total_active_alerts || 0;
                document.getElementById('water-sources').textContent = waterStats.total_sources || 0;
            } catch (error) {
                document.getElementById('total-reports').textContent = 'Error';
                document.getElementById('active-alerts').textContent = 'Error';
                document.getElementById('water-sources').textContent = 'Error';
            }
        }

        // Load alerts
        async function loadAlerts() {
            try {
                const alerts = await fetch(`${API_URL}/alerts`).then(r => r.json());
                const container = document.getElementById('alerts-container');
                
                if (alerts.length === 0) {
                    container.innerHTML = '<div style="color: white; text-align: center; padding: 20px;">‚úÖ No active alerts</div>';
                    return;
                }
                
                container.innerHTML = alerts.slice(0, 5).map(alert => `
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid ${getSeverityColor(alert.severity)};">
                        <div style="color: white; font-weight: bold;">${getSeverityIcon(alert.severity)} ${alert.severity?.toUpperCase()}</div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 14px; margin-top: 5px;">
                            üìÖ ${new Date(alert.created_at).toLocaleDateString()}
                        </div>
                        <div style="color: white; margin-top: 5px;">
                            ${alert.message || 'Health alert in your area'}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('alerts-container').innerHTML = '<div style="color: white;">‚ùå Error loading alerts</div>';
            }
        }

        function getSeverityColor(severity) {
            switch (severity?.toLowerCase()) {
                case 'critical': return '#e74c3c';
                case 'high': return '#f39c12';
                case 'medium': return '#f1c40f';
                case 'low': return '#2ecc71';
                default: return '#95a5a6';
            }
        }

        function getSeverityIcon(severity) {
            switch (severity?.toLowerCase()) {
                case 'critical': return 'üî¥';
                case 'high': return 'üü†';
                case 'medium': return 'üü°';
                case 'low': return 'üü¢';
                default: return '‚ö™';
            }
        }

        // Profile functions
        function loadProfile() {
            document.getElementById('platform').textContent = navigator.platform;
            document.getElementById('browser').textContent = navigator.userAgent.split(' ').pop();
            document.getElementById('last-active').textContent = new Date().toLocaleString();
            getLocation();
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude.toFixed(4);
                        const lon = position.coords.longitude.toFixed(4);
                        document.getElementById('location').textContent = `${lat}, ${lon}`;
                    },
                    () => {
                        document.getElementById('location').textContent = 'Location access denied';
                    }
                );
            } else {
                document.getElementById('location').textContent = 'Geolocation not supported';
            }
        }

        // PWA Install
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showMessage('üì± App installed successfully!', 'success');
                    }
                    deferredPrompt = null;
                });
            } else {
                showMessage('üì± Add this page to your home screen for app-like experience!', 'success');
            }
        }

        // Initialize app
        window.onload = function() {
            updateConnectionStatus();
            updateOfflineStats();
            getGPSLocation();
            loadAlerts();
            
            // Load saved language
            const savedLanguage = localStorage.getItem('selectedLanguage');
            if (savedLanguage) {
                document.getElementById('languageSelect').value = savedLanguage;
            }
        };
        
        // Auto-refresh data every 30 seconds
        setInterval(() => {
            if (navigator.onLine) {
                loadAlerts();
            }
            updateConnectionStatus();
        }, 30000);

        // Offline support
        window.addEventListener('online', () => {
            showMessage('üåê Back online! Syncing data...', 'success');
            updateConnectionStatus();
            syncOfflineData();
        });

        window.addEventListener('offline', () => {
            showMessage('üì± Working offline. Data will sync when connected.', 'error');
            updateConnectionStatus();
        });
    </script>
</body>
</html>